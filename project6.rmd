---
title: "Project6"
output: html_document
---
# Setup
```{r setup, include=FALSE}
source('myfunc.R') # self-defiend functions
library(tidyverse)
library(tidyr)     # new tidy functions
library(knitr) # kable
library(caret)# low variance filter
library(glmnet)
library(brglm)
library(modelsummary)
library(gridExtra)
library(kableExtra)
library(performanceEstimation)# for SMOTE
library(rpart)
library(rpart.plot)
library(rattle) #fancyRpartPlot
library(Rtsne)
library(randomForest)
library(neuralnet)
library(e1071)# SVM regression
library(mltools)
library(data.table)
library(skimr)
library(smotefamily)
library(broom)
library(jtools)
```

# Dataset

## dat2 (do not include smoke)

```{r}
#dat<-tech_biom %>% filter (AGEC >= 19, AGEC<=64, SMKSTAT==5)  # filter age and smoke status
dat<-tech_biom %>% filter (AGEC >= 19, AGEC<=64)  # filter age only
var_list<-c("BMISC","SEX","AGEC","DIABBC","HCHOLBC","HSUGBC","HYPBC","PHDCMWBC","EXLWMBC","EXLWVBC", "SYSTOL","DIASTOL","TRIGRESB","CHOLRESB","LDLRESB","HBA1PREB","GLUCFREB","HDLCHREB","CVDMEDST","APOBRESB") # add/remove variables that are interested
dat2<-dat %>% select (var_list) # select columns that we are interested
dat2$EXLWMBC<-as.numeric(as.character(dat$EXLWMBC)) # exerices time should be numeric 
dat2$EXLWVBC<-as.numeric(as.character(dat$EXLWVBC)) # exerciese time should be numeric
str(dat2) # 7238 obs x 20 variables
```
### dat2c (NA removed)

```{r}
dat2c<-na.omit(dat2)
dat2c
response<-c("DIABBC","HCHOLBC","HSUGBC","HYPBC","CVDMEDST")

Y<-dat2c[,c(4:7,19)]
X<-dat2c[,c(1:3, 8:18,20)]
str(Y)
str(X)
```


# Model

## Model 1

- Y: HCHOLBC = 1,2,3 -> Y=1; HCHOLBC = 5 ->Y=0
- X: mixture of numerical and categorical

```{r construct x and y}
y<-Y %>% mutate(
  HCHOLBC = as.factor(ifelse((HCHOLBC==5), 0, ifelse(HCHOLBC==3|HCHOLBC==2|HCHOLBC==1,1, NA)))
)
y<-y$HCHOLBC # y is binary (0,1)

x<-X%>% mutate(
  TRIGRESB=as.factor(ifelse((TRIGRESB==1|TRIGRESB==2|TRIGRESB==3),0,ifelse((TRIGRESB==4|TRIGRESB==5),1,ifelse(TRIGRESB==97|TRIGRESB==98,NA,2)))),
  
  CHOLRESB=as.factor(ifelse((CHOLRESB==1|CHOLRESB==2|CHOLRESB==3),0,ifelse((CHOLRESB==4|CHOLRESB==5|CHOLRESB==6),1,ifelse(CHOLRESB==97|CHOLRESB==98,NA,2)))),
  
  LDLRESB=as.factor(ifelse((LDLRESB==1|LDLRESB==2|LDLRESB==3|LDLRESB==4),0,ifelse((LDLRESB==5|LDLRESB==6|LDLRESB==7),1,ifelse(LDLRESB==97|LDLRESB==98,NA,2)))),
  
  GLUCFREB=as.factor(ifelse((GLUCFREB==4|GLUCFREB==5),0,ifelse((GLUCFREB==6|GLUCFREB==7),1,ifelse(GLUCFREB==97|GLUCFREB==98,NA,2)))),
  
  HDLCHREB=as.factor(ifelse((HDLCHREB==7|HDLCHREB==8),NA,ifelse((HDLCHREB==5|HDLCHREB==6),0,ifelse(HDLCHREB==1,2,1)))),
  
  APOBRESB=as.factor(ifelse((APOBRESB==1|APOBRESB==2|APOBRESB==3|APOBRESB==4),0,ifelse((APOBRESB==5),1,ifelse(APOBRESB==97|APOBRESB==98,NA,2)))),
  
  HBA1PREB=as.factor(ifelse((HBA1PREB==1|HBA1PREB==2),0,ifelse((HBA1PREB==3|HBA1PREB==4),1,ifelse(HBA1PREB==7|HBA1PREB==8,NA,2)))),
)

x<-x[,-10] # drop cholersb, do not use cholresb to predict high cholersterol 
str(x)

```



### Logistic regression
```{r}
repeats<-1
res1 <- cv_penLogistic(y,x,method="vanilla", repeats=repeats)
res2 <- cv_penLogistic(y,x,method="fowardAIC", repeats=repeats)
res3 <- cv_penLogistic(y,x,method="forwardBIC", repeats=repeats)
res4 <- cv_penLogistic(y,x,method="stepwiseAIC", repeats=repeats)
res5 <- cv_penLogistic(y,x,method="stepwiseBIC", repeats=repeats)
#res6 <- cv_penLogistic(y,xx,method="ridge", repeats=repeats)
#res7 <- cv_penLogistic(y,xx,method="lasso", repeats=repeats)
res8 <- cv_penLogistic(y,x,method="firth",repeats=repeats)
```

```{r}
tab <- cbind(
  apply(res1[[1]],2,mean),
  apply(res2[[1]],2,mean),
  apply(res3[[1]],2,mean),
  apply(res4[[1]],2,mean),
  apply(res5[[1]],2,mean),
  #apply(res6[[1]],2,mean),
  #apply(res7[[1]],2,mean),
  apply(res8[[1]],2,mean))

colnames(tab) <- c("logistic",
                   "fwdAIC",
                   "fwdBIC",
                   "bwdAIC",
                   "bwdBIC",
                   #"ridge",
                   #"lasso",
                   "firth")

boxplot(tab)

# extract coefficients of models
lcoef <- list(res1[[2]]$coef,
              res2[[2]]$coef,
              res3[[2]]$coef,
              res4[[2]]$coef,
              res5[[2]]$coef,
              #drop(coef(res6[[2]], res6[[2]]$lambda.1se )),
              #drop(coef(res7[[2]], res7[[2]]$lambda.1se )),
              res8[[2]]$coef
)

varnames <- unique(unlist(map(lcoef,names)))
tab = matrix(0, nrow = length(lcoef), ncol = length(varnames))
colnames(tab) = varnames
for (i in 1:length(lcoef)) 
  tab[i, names(lcoef[[i]])] = lcoef[[i]]

rownames(tab) <- paste("model",1:length(lcoef),sep="")
kable(t(tab))
```

Above codes show the coefficients of BMISC of many models are close to 0, suggesting BMI may not be a good indicator for predicting high cholesterol. 
On the other hand, SEX, AGE, PHDCMWBC, DIASTOL, TRIGRESB, LDLRESB, HBA1PREB, GLUCFREB, HDLCHREB, APOBRESB are important predictors for predicting high cholesterol. 


# Justify

## BMI vs. High cholesterol

```{r bmi cho}
bmi_high <- dat2%>% filter(dat2$BMISC >= 30)
nrow(bmi_high) # 1658 people high bmi
bmi_low <- dat2%>% filter(dat2$BMISC < 30)
nrow(bmi_low) # 4503 people low bmi
table(bmi_high$HCHOLBC)
table(bmi_low$HCHOLBC)
```
The claim is: BMI along is not a good indicator to diagnose high cholesterol

Based on BMI, we can see that

- 8.57% of low BMI people have high cholesterol (ideally, the majority of them should NOT have high cholesterol, since they are not in obesity according to BMI)
- 15.86% of high BMI people have high cholesterol (ideally, the majority of them should have, since they ARE in obesity according to bmi)

To beat BMI, 
方案1:
```{r}

# 重新group, 把每个predictor分成不同level, 比如 normal, bad, very bad ...
# 
str(dat2)

x_regroup <- dat2 %>% mutate(
   
   age_score<-
   bmi_score<-
   对每个 predictor 设置level..
   .....
  
   Tri_score=as.factor(ifelse((TRIGRESB==1|TRIGRESB==2|TRIGRESB==3),0,ifelse((TRIGRESB==4|TRIGRESB==5),1,ifelse(TRIGRESB==97|TRIGRESB==98,NA,2)))),
  
   Chol_score=as.factor(ifelse((CHOLRESB==1|CHOLRESB==2|CHOLRESB==3),0,ifelse((CHOLRESB==4|CHOLRESB==5|CHOLRESB==6),1,ifelse(CHOLRESB==97|CHOLRESB==98,NA,2)))),
  
  LDL_score=as.factor(ifelse((LDLRESB==1|LDLRESB==2|LDLRESB==3|LDLRESB==4),0,ifelse((LDLRESB==5|LDLRESB==6|LDLRESB==7),1,ifelse(LDLRESB==97|LDLRESB==98,NA,2)))),
  
  Glu_score=as.factor(ifelse((GLUCFREB==4|GLUCFREB==5),0,ifelse((GLUCFREB==6|GLUCFREB==7),1,ifelse(GLUCFREB==97|GLUCFREB==98,NA,2)))),
  
  HDL_score=as.factor(ifelse((HDLCHREB==7|HDLCHREB==8),NA,ifelse((HDLCHREB==5|HDLCHREB==6),0,ifelse(HDLCHREB==1,2,1)))),
  
  
  ApoB_score=as.factor(ifelse((APOBRESB==1|APOBRESB==2|APOBRESB==3|APOBRESB==4),0,ifelse((APOBRESB==5),1,ifelse(APOBRESB==97|APOBRESB==98,NA,2)))),
  
  HbA1c_score=as.factor(ifelse((HBA1PREB==1|HBA1PREB==2),0,ifelse((HBA1PREB==3|HBA1PREB==4),1,ifelse(HBA1PREB==7|HBA1PREB==8,NA,2)))),
)

x_predictors <- x %>% select (BMISC, SEX, AGEC, PHDCMWBC, EXLWMBC, EXLWVBC, SYSTOL, DIASTOL, TRIGRESB, LDLRESB, HBA1PREB, GLUCFREB, HDLCHREB, APOBRESB)
}

# 根据X regroup, 对于每个人, SUMMATION[每个predictor的分数 × predictor在回归模型的系数]-> 给每个人算出一个obesity score
....
# 再给obesity score 找一个threshold 
# 目标是 对于>threshold (肥胖人群), 高胆固醇发病率>15.86% 
# <threshold 人群, 高胆固醇发病率 < 8.57%

```
方案2:
直接使用 回归模型的Cross validation结果. 如logistic regression的model 1的错误率是15%, 则说明有15%的人被误判, 和BMI结果对比发现, 高BMI人群 有100%-15.86%的人没有得病: 即 若根据 BMI>30 -> high cholesterol = 1 来判断, 则相当于有接近85%的人会被误判


